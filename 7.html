<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图像转ASCII字符显示</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            text-align: center;
            margin: 20px;
            background-color: rgb(48, 160, 152);
            color: white;
            user-select: none; /* 禁止文本选择 */
        }

        h1 {
            color: white;
        }

        #uploadButton {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            text-decoration: none;
            color: white;
            background: linear-gradient(to right, #3498db, #9b59b6);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
            top: -15px;
        }

        #uploadButton:hover {
            background: linear-gradient(to right, #9b59b6, #3498db);
        }

        #fileLabel {
            color: white;
            margin-top: 10px;
        }

        #asciiOutputWrapper {
            overflow-x: auto; /* 添加水平滚动条 */
            overflow-y: auto; /* 添加垂直滚动条 */
            max-height: 500px; /* 设置最大高度 */
            margin-top: 10px; /* 上移ASCII区域 */
        }

        #asciiOutput {
            font-size: 10px;
            white-space: pre-wrap;
            background-color: #000000;
            padding: 10px;
            display: inline-block;
            color: rgb(0, 255, 68); /* 将ASCII文本颜色设置为黑色 */
        }

        .action-button {
            display: none;
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            text-decoration: none;
            color: white;
            background: linear-gradient(to right, #3498db, #9b59b6);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .action-button:hover {
            background: linear-gradient(to right, #9b59b6, #3498db);
        }

        #downloadTxtButton, #downloadImageBtn {
            background: #133089;
        }
    </style>
</head>
<body>
    <h1>图像转ASCII字符显示</h1>
    
    <input type="file" id="imageInput" accept="image/*" style="display: none;">
    <button id="uploadButton">选择图片</button>
    <br>
    <span id="fileLabel"></span>
    <br><br>
    <div id="asciiOutputWrapper">
        <pre id="asciiOutput"></pre>
    </div>

    <button id="downloadTxtButton" class="action-button">下载ASCII文本</button>
    <button id="downloadImageBtn" class="action-button">下载ASCII图像</button>

    <script>
        const uploadButton = document.getElementById('uploadButton');
        const downloadTxtButton = document.getElementById('downloadTxtButton');
        const downloadImageBtn = document.getElementById('downloadImageBtn');

        uploadButton.addEventListener('click', function () {
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', handleImage);

        function handleImage(event) {
            const input = event.target;
            const reader = new FileReader();

            reader.onload = function () {
                const img = new Image();
                img.src = reader.result;

                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // 将图片宽度调整为500px，高度按比例缩放
                    const newWidth = 800;
                    const scaleFactor = newWidth / img.width;
                    canvas.width = newWidth * 2.5;
                    canvas.height = img.height * scaleFactor;

                    // 将图片绘制到画布上
                    ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // 将图片转换为黑白
                    for (let i = 0; i < data.length; i += 4) {
                        const grayscale = data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11;
                        data[i] = grayscale;
                        data[i + 1] = grayscale;
                        data[i + 2] = grayscale;
                    }

                    ctx.putImageData(imageData, 0, 0);

                    // 打码并显示转换后的图片
                    const asciiOutput = document.getElementById('asciiOutput');
                    const asciiArt = pixelateAndGetAscii(ctx, 20);
                    asciiOutput.textContent = asciiArt;

                    // 显示选择的文件名
                    const fileLabel = document.getElementById('fileLabel');
                    fileLabel.textContent = `选择的文件：${input.files[0].name}`;

                    // 显示按钮
                    downloadTxtButton.style.display = 'inline-block';
                    downloadImageBtn.style.display = 'inline-block';
                };
            };

            reader.readAsDataURL(input.files[0]);
        }

        downloadTxtButton.addEventListener('click', function () {
            const asciiOutput = document.getElementById('asciiOutput').textContent;
            const blob = new Blob([asciiOutput], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ascii.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        downloadImageBtn.addEventListener('click', function () {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const asciiOutput = document.getElementById('asciiOutput');
            const fontSize = parseInt(window.getComputedStyle(asciiOutput).fontSize);
            const lineHeight = Math.floor(fontSize * 1.2);
            canvas.width = asciiOutput.clientWidth;
            canvas.height = asciiOutput.clientHeight;

            // 将ASCII文本绘制到画布上
            ctx.font = `${fontSize}px Courier New`;
            ctx.fillStyle = 'rgb(0, 255, 68)';
            asciiOutput.textContent.split('\n').forEach((line, index) => {
                ctx.fillText(line, 0, (index + 1) * lineHeight);
            });

            // 创建图像并下载
            const image = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = image;
            a.download = 'ascii_image.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        function pixelateAndGetAscii(context, blockSize) {
            const imageData = context.getImageData(0, 0, context.canvas.width, context.canvas.height);
            const data = imageData.data;
            let asciiArt = '';

            // ASCII字符集，可以根据需要进行调整
            const asciiChars = ['@', '#', 'S', '%', '?', '*', '+', ';', ':', ',', '.'];

            // 分割为小块，计算每块的平均灰度值
            for (let y = 0; y < context.canvas.height; y += blockSize) {
                for (let x = 0; x < context.canvas.width; x += blockSize) {
                    let sumGray = 0, count = 0;

                    // 计算每块的平均灰度值
                    for (let blockY = y; blockY < y + blockSize && blockY < context.canvas.height; blockY++) {
                        for (let blockX = x; blockX < x + blockSize && blockX < context.canvas.width; blockX++) {
                            const index = (blockY * context.canvas.width + blockX) * 4;
                            sumGray += data[index];
                            count++;
                        }
                    }

                    // 计算平均灰度值
                    const avgGray = sumGray / count;

                    // 映射到ASCII字符集
                    const asciiIndex = Math.floor((avgGray / 255) * (asciiChars.length - 1));
                    const asciiChar = asciiChars[asciiIndex];

                    // 添加到ASCII艺术字符串
                    asciiArt += asciiChar;
                }

                // 换行
                asciiArt += '\n';
            }

            return asciiArt;
        }
    </script>
</body>
</html>
