<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图像转ASCII字符显示</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            text-align: center;
            margin: 20px;
            background-color: rgb(48, 160, 152);
            color: white;
        }

        h1 {
            color: white;
        }

        #uploadButton {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            text-decoration: none;
            color: white;
            background: linear-gradient(to right, #3498db, #9b59b6);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
            top: -15px;
        }

        #uploadButton:hover {
            background: linear-gradient(to right, #9b59b6, #3498db);
        }

        #fileLabel {
            color: white;
            margin-top: 10px;
        }

        #asciiOutput {
            font-size: 10px;
            white-space: pre-wrap;
            margin-top: 10px; /* 上移ASCII区域 */
            background-color: #000000;
            padding: 10px;
            display: inline-block;
            color: rgb(0, 255, 68); /* 将ASCII文本颜色设置为黑色 */
        }

        #outputCanvas {
            max-width: 100%;
            width: 1250px;
            height: 500px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>图像转ASCII字符显示</h1>
    
    <input type="file" id="imageInput" accept="image/*" style="display: none;">
    <button id="uploadButton">选择图片</button>
    <br>
    <span id="fileLabel"></span>
    <br><br>
    <pre id="asciiOutput"></pre>

    <script>
        document.getElementById('uploadButton').addEventListener('click', function () {
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', handleImage);

        function handleImage(event) {
            const input = event.target;
            const reader = new FileReader();

            reader.onload = function () {
                const img = new Image();
                img.src = reader.result;

                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // 将图片宽度调整为1000px，高度按比例缩放
                    const newWidth = 1000;
                    const scaleFactor = newWidth / img.width;
                    canvas.width = newWidth;
                    canvas.height = img.height * scaleFactor / 2.25;

                    // 将图片绘制到画布上
                    ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // 将图片转换为黑白
                    for (let i = 0; i < data.length; i += 4) {
                        const grayscale = data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11;
                        data[i] = grayscale;
                        data[i + 1] = grayscale;
                        data[i + 2] = grayscale;
                    }

                    ctx.putImageData(imageData, 0, 0);

                    // 打码并显示转换后的图片
                    const asciiOutput = document.getElementById('asciiOutput');
                    const asciiArt = pixelateAndGetAscii(ctx, 20);
                    asciiOutput.textContent = asciiArt;

                    // 显示打码后的图片
                    const outputCanvas = document.getElementById('outputCanvas');
                    outputCanvas.width = canvas.width;
                    outputCanvas.height = canvas.height;
                    const outputCtx = outputCanvas.getContext('2d');
                    outputCtx.drawImage(ctx.canvas, 0, 0, canvas.width, canvas.height);

                    // 显示选择的文件名
                    const fileLabel = document.getElementById('fileLabel');
                    fileLabel.textContent = `选择的文件：${input.files[0].name}`;
                };
            };

            reader.readAsDataURL(input.files[0]);
        }

        function pixelateAndGetAscii(context, blockSize) {
            const imageData = context.getImageData(0, 0, context.canvas.width, context.canvas.height);
            const data = imageData.data;
            let asciiArt = '';

            // ASCII字符集，可以根据需要进行调整
            const asciiChars = ['@', '#', 'S', '%', '?', '*', '+', ';', ':', ',', '.'];

            // 分割为小块，计算每块的平均灰度值
            for (let y = 0; y < context.canvas.height; y += blockSize) {
                for (let x = 0; x < context.canvas.width; x += blockSize) {
                    let sumGray = 0, count = 0;

                    // 计算每块的平均灰度值
                    for (let blockY = y; blockY < y + blockSize && blockY < context.canvas.height; blockY++) {
                        for (let blockX = x; blockX < x + blockSize && blockX < context.canvas.width; blockX++) {
                            const index = (blockY * context.canvas.width + blockX) * 4;
                            sumGray += data[index];
                            count++;
                        }
                    }

                    // 计算平均灰度值
                    const avgGray = sumGray / count;

                    // 映射到ASCII字符集
                    const asciiIndex = Math.floor((avgGray / 255) * (asciiChars.length - 1));
                    const asciiChar = asciiChars[asciiIndex];

                    // 添加到ASCII艺术字符串
                    asciiArt += asciiChar;
                }

                // 换行
                asciiArt += '\n';
            }

            return asciiArt;
        }
    </script>
</body>
</html>
